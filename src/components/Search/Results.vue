<template>
  <div>
    <b-row class="sortbar" align-h="end">
      <b-col cols="2">
        <small class="fda">Sort profiles by: </small>
        <b-form-radio-group
          id="btnradios"
          v-model="sortBy"
          :options="options"
          buttons
          name="radioBtnStacked" />
      </b-col>
    </b-row>
    <profile-card
      v-for="profile in ordered"
      :key="profile.id"
      :profile="profile" />
  </div>
</template>

<script>
import _ from 'lodash'
import { mapGetters } from 'vuex'
import ProfileCard from './ProfileCard'

export default {
  name: 'Results',
  components: {
    ProfileCard
  },
  props: {
    filterName: String,
    filterSkills: Array
  },
  data () {
    return {
      filteredProfiles: {},
      sortBy: 'name',
      options: [
        { text: 'Name', value: 'name' },
        { text: 'Skills', value: 'knows' },
        { text: 'Willingness', value: 'wantsTo' }
      ]
    }
  },
  computed: {
    ...mapGetters([
      'profileFilter',
      'skillsByProfileId',
      'skillById',
      'profiles'
    ]),
    filterSkillIds () {
      return this.filterSkills.map(skill => skill.id)
    },
    ordered () {
      const sortBy = !_.isEmpty(this.filterSkillIds) ? this.sortBy : 'name'
      return this.orderMap[sortBy].map(sortItem => this.filteredProfiles[sortItem.profileId])
    },
    orderMap () {
      const orderMap = {
        knows: [],
        wantsTo: [],
        name: []
      }
      const skillFilterCnt = this.filterSkillIds.length
      if (this.filteredProfiles) {
        Object.values(this.filteredProfiles).forEach(profile => {
          const knows = []
          const wantsTo = []
          let cnt = 0
          this.skillsByProfileId(profile.id).forEach(profileSkill => {
            if (this.filterSkillIds.includes(profileSkill.skillId)) {
              knows.push(profileSkill.knows)
              wantsTo.push(profileSkill.wantsTo)
              cnt += 1
            }
          })
          if (cnt === skillFilterCnt) {
            orderMap.knows.push({ profileId: profile.id, value: _.max(knows) })
            orderMap.wantsTo.push({ profileId: profile.id, value: _.max(wantsTo) })
            orderMap.name.push({ profileId: profile.id, value: profile.firstName.toLowerCase() })
          }
        })
        orderMap.knows.sort((a, b) => b.value - a.value)
        orderMap.wantsTo.sort((a, b) => b.value - a.value)
        orderMap.name.sort((a, b) => a.value > b.value ? 1 : -1)
      }
      return orderMap
    }
  },
  watch: {
    filterName: function () {
      this.delayedSearch()
    },
    profiles: function () {
      this.search()
    }
  },
  mounted () {
    this.search()
  },
  methods: {
    delayedSearch: _.debounce(
      function () {
        this.search()
      },
      200 // Wait between searches can be changed here
    ),
    search () {
      const results = this.profileFilter(this.filterName)
        .filter(profile => {
          if (!_.isEmpty(this.filterSkillIds)) {
            const profilesSkills = this.skillsByProfileId(profile.id)
              .filter(profileSkill => {
                return profileSkill.knows > 0 || profileSkill.wantsTo > 0
              })
              .map(profileSkill => profileSkill.skillId)
            const common = _.intersection(profilesSkills, this.filterSkillIds)
            return !_.isEmpty(common)
          }
          return true
        })

      this.filteredProfiles = _.keyBy(results, 'id')
    }
  }
}
</script>

<style scoped>
.sortbar {
  font-size: 40px !important;
  padding: 10px !important;
}
</style>
